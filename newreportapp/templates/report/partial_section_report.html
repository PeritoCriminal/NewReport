<!-- newreport/templates/report/partial_section_report_form.html - mantenha essa linha quando copiar o arquivo -->

<form method="POST" action="{{ action_url }}" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Campo para título -->
    <div class="form-group">
        {{ form.title.label_tag }}
        {{ form.title }}
        {% if form.title.help_text %}
            <small class="form-text text-muted">{{ form.title.help_text }}</small>
        {% endif %}
    </div>

    <!-- Campo para descrição -->
    <div class="form-group">
        {{ form.description.label_tag }}
        {{ form.description }}
        {% if form.description.help_text %}
            <small class="form-text text-muted">{{ form.description.help_text }}</small>
        {% endif %}
    </div>

    <!-- Campo para Header Report (se aplicável) -->
    {% if header_report_instance %}
        <div class="form-group">
            <label class="form-label">Relatório de Cabeçalho</label>
            <input type="text" class="form-control" value="{{ header_report_instance }}" disabled>
        </div>
    {% else %}
        <div class="form-group">
            {{ form.header_report_model.label_tag }}
            {{ form.header_report_model }}
            {% if form.header_report_model.help_text %}
                <small class="form-text text-muted">{{ form.header_report_model.help_text }}</small>
            {% endif %}
        </div>
    {% endif %}



    <div class="form-group d-flex justify-content-between">
        <button type="submit" class="btn btn-primary">Salvar</button>
        <a href="{% url 'show_report' header_report_id %}" class="btn btn-secondary">Voltar</a>
    </div>
</form>

<hr class="my-4">

{% if images %}
    <h3>Imagens Associadas</h3>
    {% for image_instance in images %}
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; padding: 10px;">
            <div style="display: flex; align-items: center;">
                <!-- Imagem -->
                <img src="{{ image_instance.img.url }}" alt="{{ image_instance.caption }}" style="max-width: 200px; margin-right: 20px;">
                
                <!-- Descrição -->
                <p style="margin: 0;">{{ image_instance.description | linebreaks }}</p>
            </div>
        </div>
        <!-- Legenda -->
        <p style="margin: 5px 0;">{{ image_instance.caption }}</p>
            <!-- Ícones de ações -->
        <div>
            <a href="#" title="Editar">
                <i 
                    class="fas fa-edit" 
                    data-image-id="{{ image_instance.id }}" 
                    data-description="{{ image_instance.description }}" 
                    data-caption="{{ image_instance.caption }}" 
                    data-image-url="{{ image_instance.img.url }}" 
                    style="color: #007bff; margin-right: 10px;">
                </i>            
            </a>
            
            <form action="{% url 'delete_image' image_instance.id %}" method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit" title="Excluir" onclick="return confirm('Tem certeza de que deseja excluir esta imagem?');" style="background: none; border: none; cursor: pointer;">
                    <i class="fas fa-trash-alt" style="color: #dc3545;"></i>
                </button>
            </form>            
        </div>

        <hr class="my-4">

    {% endfor %}
{% else %}
    <p>Nenhuma imagem associada.</p>
{% endif %}


{% if report_section.id %}
        {% include "modal_image.html" %}
{% else %}
    <p>Após salvar este formulário, você poderá adicionar imagens com seus respectivos comentários e legendas.</p>
{% endif %}

{% block scripts %}
<script>
    // Classe para manipulação da imagem
    class ImageObject {
        constructor(image, ctx, width, height) {
            if (!image || !ctx) {
                throw new Error("É necessário selecionar uma imagem.");
            }
            this.image = image;
            this.ctx = ctx;
            this.left = 0;
            this.top = 0;
            this.width = width; // Use as dimensões redimensionadas
            this.height = height; // Use as dimensões redimensionadas
            this.sizeProportion = this.height / this.width;
            this.operation = {
                isZooming: false,
                isPanning: false,
                isDragging: false,
                startX: 0,
                startY: 0,
                presentX: 0,
                presentY: 0,
                initialWidth: 0,
                initialHeight: 0,
            };
    
            // Eventos do mouse
            this.addMouseEvents();
        }

        adjustPosition(newLeft, newTop) {
            const canvas = this.ctx.canvas;
        
            if (newLeft > 0) {
                newLeft = 0;
            } else if (newLeft + this.width < canvas.width) {
                newLeft = canvas.width - this.width;
            }
        
            if (newTop > 0) {
                newTop = 0;
            } else if (newTop + this.height < canvas.height) {
                newTop = canvas.height - this.height;
            }
        
            return { adjustedLeft: newLeft, adjustedTop: newTop };
        }

        addMouseEvents() {
            const canvas = this.ctx.canvas;
            canvas.addEventListener('mousedown', (e) => this.onMouseDown(e));
            canvas.addEventListener('mousemove', (e) => this.onMouseMove(e));
            canvas.addEventListener('mouseup', () => this.onMouseUp());
            canvas.addEventListener('mouseout', () => this.onMouseUp());
        }

        draw() {
            this.ctx.clearRect(0, 0, this.ctx.canvas.width, this.ctx.canvas.height);
            this.ctx.drawImage(this.image, this.left, this.top, this.width, this.height);
        }

        onMouseDown(event) {
            this.operation.isDragging = true;
            this.operation.startX = event.clientX;
            this.operation.startY = event.clientY;
            this.operation.presentX = event.clientX;
            this.operation.presentY = event.clientY;
            this.operation.initialWidth = this.width;
            this.operation.initialHeight = this.height;
            this.yProportion = this.operation.startY / this.height;
        }

        onMouseMove(event) {
            if (this.operation.isDragging){
                if (this.operation.isZooming){
                    if(this.operation.isDragging) {
                        this.newZoom(event);
                    }
                }
                if(this.operation.isPanning){
                    this.drag(event);
                }
            }
            
        }

        onMouseUp() {
            this.operation.isDragging = false;
            this.operation.isZooming = false;
            this.operation.isPanning = false;
            document.body.style.cursor = "default";
        }


        newZoom(event) {
            let factorX = 0;
            if (event.clientY - this.operation.presentY < 1) {
                if (this.width > this.ctx.canvas.width) {
                    factorX = -10;
                }
            } else {
                factorX = 10;
            }
            this.operation.presentY = event.clientY;
            const newWidth = this.width + factorX;
            const newHeight = newWidth * this.sizeProportion;        
            const newLeft = this.left - factorX / 2;
            const newTop = this.top - (factorX / 2) * this.sizeProportion;
            const { adjustedLeft, adjustedTop } = this.adjustPosition(newLeft, newTop);
            this.width = newWidth;
            this.height = newHeight;
            this.left = adjustedLeft;
            this.top = adjustedTop;
            this.draw();
        }
        

        drag(event) {
            const deltaX = event.clientX - this.operation.presentX;
            const deltaY = event.clientY - this.operation.presentY;
        
            const { adjustedLeft, adjustedTop } = this.adjustPosition(this.left + deltaX, this.top + deltaY);
        
            this.left = adjustedLeft;
            this.top = adjustedTop;
        
            this.operation.presentX = event.clientX;
            this.operation.presentY = event.clientY;
        
            this.draw();
        }
        
        
    }



    // Manipulação do modal de edição
   document.querySelectorAll('.fa-edit').forEach((element) => {
    element.addEventListener('click', (event) => {
        event.preventDefault();

        const imageId = element.getAttribute('data-image-id');
        const description = element.getAttribute('data-description');
        const caption = element.getAttribute('data-caption');
        const imageUrl = element.getAttribute('data-image-url');

        document.querySelector('#image_id').value = imageId;
        document.querySelector('#imageDescription').value = description;
        document.querySelector('#imageCaption').value = caption;

        const canvas = document.querySelector('#imageCanvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();

        img.onload = () => {
            // Define o tamanho máximo para o canvas
            const maxWidth = 800;
            const maxHeight = 600;

            // Calcula a escala proporcional
            const ratio = Math.min(maxWidth / img.width, maxHeight / img.height);
            const newWidth = img.width * ratio;
            const newHeight = img.height * ratio;

            // Ajusta o tamanho do canvas
            canvas.width = newWidth;
            canvas.height = newHeight;

            // Desenha a imagem redimensionada no canvas
            ctx.drawImage(img, 0, 0, newWidth, newHeight);

            // Cria o objeto ImageObject com as dimensões redimensionadas
            imageObject = new ImageObject(img, ctx, newWidth, newHeight);
        };

        img.src = imageUrl;

        $('#imageModal').modal('show');
    });
});

</script>
{% endblock scripts %}
