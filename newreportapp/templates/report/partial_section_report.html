<!-- newreport/templates/report/partial_section_report_form.html - mantenha essa linha quando copiar o arquivo -->

<form method="POST" action="{{ action_url }}" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Campo para título -->
    <div class="form-group">
        {{ form.title.label_tag }}
        {{ form.title }}
        {% if form.title.help_text %}
            <small class="form-text text-muted">{{ form.title.help_text }}</small>
        {% endif %}
    </div>

    <!-- Campo para descrição -->
    <div class="form-group">
        {{ form.description.label_tag }}
        {{ form.description }}
        {% if form.description.help_text %}
            <small class="form-text text-muted">{{ form.description.help_text }}</small>
        {% endif %}
    </div>

    <!-- Campo para Header Report (se aplicável) -->
    {% if header_report_instance %}
        <div class="form-group">
            <label class="form-label">Relatório de Cabeçalho</label>
            <input type="text" class="form-control" value="{{ header_report_instance }}" disabled>
        </div>
    {% else %}
        <div class="form-group">
            {{ form.header_report_model.label_tag }}
            {{ form.header_report_model }}
            {% if form.header_report_model.help_text %}
                <small class="form-text text-muted">{{ form.header_report_model.help_text }}</small>
            {% endif %}
        </div>
    {% endif %}



    <div class="form-group d-flex justify-content-between">
        <button type="submit" class="btn btn-primary">Salvar</button>
        <a href="{% url 'show_report' header_report_id %}" class="btn btn-secondary">Voltar</a>
    </div>
</form>

<hr class="my-4">

{% if images %}
    <h3>Imagens Associadas</h3>
    {% for image_instance in images %}
        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; padding: 10px;">
            <div style="display: flex; align-items: center;">
                <!-- Imagem -->
                <img src="{{ image_instance.img.url }}" alt="{{ image_instance.caption }}" style="max-width: 200px; margin-right: 20px;">
                
                <!-- Descrição -->
                <p style="margin: 0;">{{ image_instance.description | linebreaks }}</p>
            </div>
        </div>
        <!-- Legenda -->
        <p style="margin: 5px 0;">{{ image_instance.caption }}</p>
            <!-- Ícones de ações -->
        <div>
            <a href="#" title="Editar">
                <i 
                    class="fas fa-edit" 
                    data-image-id="{{ image_instance.id }}" 
                    data-description="{{ image_instance.description }}" 
                    data-caption="{{ image_instance.caption }}" 
                    data-image-url="{{ image_instance.img.url }}" 
                    style="color: #007bff; margin-right: 10px;">
                </i>            
            </a>
            
            <form action="{% url 'delete_image' image_instance.id %}" method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit" title="Excluir" onclick="return confirm('Tem certeza de que deseja excluir esta imagem?');" style="background: none; border: none; cursor: pointer;">
                    <i class="fas fa-trash-alt" style="color: #dc3545;"></i>
                </button>
            </form>            
        </div>

        <hr class="my-4">

    {% endfor %}
{% else %}
    <p>Nenhuma imagem associada.</p>
{% endif %}


{% if report_section.id %}
        {% include "modal_image.html" %}
{% else %}
    <p>Após salvar este formulário, você poderá adicionar imagens com seus respectivos comentários e legendas.</p>
{% endif %}

{% block scripts %}
    <script>
        document.querySelectorAll('.fa-edit').forEach((element) => {
            element.addEventListener('click', (event) => {
                event.preventDefault(); // Previne o comportamento padrão do link

                // Obtém os dados armazenados nos atributos data-*
                const imageId = element.getAttribute('data-image-id');
                const description = element.getAttribute('data-description');
                const caption = element.getAttribute('data-caption');
                const imageUrl = element.getAttribute('data-image-url');

                // Preenche os elementos da janela modal com os dados da imagem
                document.querySelector('#image_id').value = imageId;
                document.querySelector('#imageDescription').value = description;
                document.querySelector('#imageCaption').value = caption;

                // Carrega a imagem no canvas
                const canvas = document.querySelector('#imageCanvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                };
                img.src = imageUrl;

                // Abre o modal de edição
                $('#imageModal').modal('show');
            });
        });

    </script>
{% endblock scripts %}


