<!-- modal_image.html -->
<!-- newreportapp/templates/modal_image.html - Manter essa linha ao copiar o arquivo -->

<!-- Botão para abrir o explorador, escolher uma imagem e abrir a janela de edição -->
<button type="button" class="btn btn-outline-primary" id="openImageModal">
    <i class="fas fa-image"></i> Adicionar Imagem
</button>

<!-- Janela modal para edição de imagens -->
<div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Editar Imagem</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="imageForm" method="POST" action="{% url 'save_image_report' %}">
                    {% csrf_token %}
                    
                    <!-- Campo oculto para armazenar o ID da imagem -->
                    <input type="hidden" id="image_id" name="image_id" value="">
                    
                    <!-- Campo oculto para armazenar o ID da seção do relatório -->
                    <input type="hidden" id="section_id_for_image" name="section_id" value="{{ report_section_id }}">
                
                    <!-- Barra de ferramentas -->
                    <div class="mb-3 text-right">
                        <button type="button" id="change_img" class="btn btn-sm btn-outline-primary" title="Alterar imagem">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button type="button" id="zoom" class="btn btn-sm btn-outline-primary" title="Zoom">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button type="button" id="rotate_clockwise" class="btn btn-sm btn-outline-primary" title="Girar horário">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button type="button" id="rotate_counterclockwise" class="btn btn-sm btn-outline-primary" title="Girar antihorário">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button type="button" id="crop" class="btn btn-sm btn-outline-primary" title="Cortar">
                            <i class="fas fa-crop"></i>
                        </button>
                        <button type="button" id="blur" class="btn btn-sm btn-outline-primary" title="Desfocar">
                            <i class="fas fa-tint-slash"></i>
                        </button>
                        <button type="button" id="add_text" class="btn btn-sm btn-outline-primary" title="Inserir texto">
                            <i class="fas fa-font"></i>
                        </button>
                        <button type="button" id="add_description" class="btn btn-sm btn-outline-primary" title="Inserir descrição">
                            <i class="fas fa-align-left"></i>
                        </button>
                        <button type="button" id="add_caption" class="btn btn-sm btn-outline-primary" title="Inserir legenda">
                            <i class="fas fa-quote-right"></i>
                        </button>
                        <button type="button" id="add_numbered_marker" class="btn btn-sm btn-outline-primary" title="Inserir marcador numerado">
                            <i class="fas fa-list-ol"></i>
                        </button>
                        <button type="submit" id="saveImageButton" class="btn btn-sm btn-outline-success" title="Salvar">
                            <i class="fas fa-save"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" data-dismiss="modal" title="Cancelar">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Campo de descrição -->
                    <div class="form-group">
                        <textarea id="imageDescription" name="description" class="form-control" rows="2"
                            placeholder="Descrição da imagem (opcional).">{{ image.description }}</textarea>
                    </div>
                
                    <!-- Campo de legenda -->
                    <div class="form-group">
                        <input type="text" class="form-control" id="imageCaption" name="caption"
                            placeholder="Legenda da imagem.">
                    </div>
                
                    <!-- Visualização da imagem no canvas -->
                    <div class="form-group">
                        <canvas id="imageCanvas" class="border w-100"></canvas>
                    </div>
                
                    <!-- Campo oculto para upload de imagem -->
                    <input type="file" id="imageInput" accept="image/*" class="d-none">
                </form>                
            </div>
        </div>
    </div>
</div>

{% block scripts %}


<script>
    let selectedImg = ''// Aqui será a imagem escolhida pelo usuário
    let canvasImg = ''// Aqui será a imagem manipulada no canvas
    const openImageModal = document.querySelector('#openImageModal');
    const change_img = document.querySelector('#change_img');
    const zoom = document.querySelector('#zoom');
    const rotate_clockwise = document.querySelector('#rotate_clockwise');
    const rotate_counterclockwise = document.querySelector('#rotate_counterclockwise');
    const crop = document.querySelector('#crop');
    const blur = document.querySelector('#blur');
    const add_text = document.querySelector('#add_text');
    const add_description = document.querySelector('#add_description');
    const add_caption = document.querySelector('#add_caption');
    const add_numbered_marker = document.querySelector('#add_numbered_marker');
    const saveImageButton = document.querySelector('#saveImageButton');
    const imageInput = document.querySelector('#imageInput');
    const canvas = document.querySelector('#imageCanvas');

    openImageModal.addEventListener('click', function(event){
        event.preventDefault();
        selectImgAndDraw();
    });

    change_img.addEventListener('click', function(event){
        event.preventDefault();
        selectImgAndDraw();
    });

    zoom.addEventListener('click', function(event){
        console.log('Clicou no canvas');
    });

    canvas.addEventListener('click', function(event){
        const coords = getCord(canvas, event);
        console.log(`Coordenadas: ${coords.x}, ${coords.y}; Zoon: ${operationState.isZooming}`);
    });

    imageInput.addEventListener('change', function(event){
        event.preventDefault();
        selectImgAndDraw();
    });

    function selectImgAndDraw() {
        // Verifica se o modal está aberto
        const modal = $('#imageModal');
        if (!modal.hasClass('show')) {
            modal.modal('show');
        }
    
        // Aciona o explorador de arquivos
        imageInput.click();
    
        imageInput.onchange = function (event) {
            const file = event.target.files[0]; // Obtém o arquivo selecionado
            if (!file) {
                // Retorna se o usuário cancelar a seleção
                return;
            }
    
            const reader = new FileReader();
            reader.onload = function (e) {
                const ctx = canvas.getContext('2d');
                const img = new Image();
    
                img.onload = function () {
                    // Define as dimensões máximas para o canvas
                    const maxWidth = 800;
                    const maxHeight = 600;
                    const ratio = Math.min(maxWidth / img.width, maxHeight / img.height);
    
                    // Redimensiona a imagem mantendo a proporção
                    const newWidth = img.width * ratio;
                    const newHeight = img.height * ratio;
    
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
    
                    // Atualiza as variáveis globais
                    selectedImg = file;
                    canvasImg = canvas.toDataURL(); // Armazena a imagem no canvas como base64
                };
    
                img.src = e.target.result;
            };
    
            reader.readAsDataURL(file);
        };
    }
    

</script>
    
{% endblock scripts %}
