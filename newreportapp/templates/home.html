{% extends 'base.html' %}

{% block title %}Home{% endblock title %}

{% block content %}
<div class="mt-4 border p-4 bg-light shadow-sm rounded">
    {% if not is_authenticated %}
        <h3 class="titulo-2">Bem-vindo</h3>
        <p>MYREPORT é um projeto independente.</p>
        <p>Tem como objetivo oferecer um ambiente seguro e eficiente para a elaboração e edição de laudos periciais, 
            inicialmente desenvolvido para Peritos Criminais Oficiais do Estado de São Paulo.</p>
        <p>Faça login ou registre-se.</p>
    {% else %}
        {% if page_obj %}
            <ul class="ul-post">
                {% for post in page_obj %}
                    <li id="post-{{ post.id }}">
                        <div class="post-header">
                            {% if post.author.photo %}
                                <img src="{{ post.author.photo.url }}" alt="Foto de {{ post.author }}" class="user-thumbnail">
                            {% endif %}
                            {% if post.caption %}
                                <span class="titulo-post">{{ post.caption }}</span>
                            {% endif %}
                        </div>
                        <p>{{ post.content|linebreaks }}</p>
                        {% if post.image %}
                            <img src="{{ post.image.url }}" alt="Imagem do Post" class="imgpost">
                            <em>Publicado por <strong>{{ post.author.username }}</strong> em {{ post.created_at }}</em>
                        {% endif %}
                        <div class="interaction-bar">
                            <span id="likes-count-{{ post.id }}">{{ post.likes_count }}</span>
                            <a href="#" class="icon-like" data-post-id="{{ post.id }}">
                                <i class="fas fa-thumbs-up"></i>
                            </a>
                            <a href="#" class="icon-comment" data-post-id="{{ post.id }}">
                                <i class="fas fa-comment"></i> Comentar
                            </a>
                            <div id="post-{{ post.id }}">
                                {% if request.user == post.author %}
                                    <a href="#" class="icon-delete delete-post" data-post-id="{{ post.id }}">
                                        <i class="fas fa-trash"></i> Deletar
                                    </a>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Seção de comentários -->
                        <div class="comment-section" id="comment-section-{{ post.id }}" style="display: none;">
                            <textarea class="comment-input" placeholder="Digite seu comentário..." rows="3"></textarea>
                            <div class="comment-buttons">
                                <button class="btn btn-primary submit-comment" data-post-id="{{ post.id }}">Salvar</button>
                                <button class="btn btn-secondary cancel-comment">Cancelar</button>
                            </div>
                        </div>

                        <!-- Exibição dos comentários existentes -->
                        <div class="comments-list" id="comments-list-{{ post.id }}">
                            {% for comment in post.comments.all|dictsortreversed:"created_at" %}
                                <div class="comment">
                                    <strong>{{ comment.user.username }}</strong> comentou em {{ comment.created_at }}.
                                    <p>{{ comment.content|linebreaks }}</p>
                                </div>
                            {% empty %}
                                <div class="no-comments">Nenhum comentário ainda.</div>
                            {% endfor %}
                        </div>        
                    </li>
                {% endfor %}
            </ul>

            <!-- Links de paginação -->
            <div class="pagination">
                <span class="step-links">
                    {% if page_obj.has_previous %}
                        <a href="?page=1">&laquo; primeira</a>
                        <a href="?page={{ page_obj.previous_page_number }}">anterior</a>
                    {% endif %}

                    <span class="current">
                        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                    </span>

                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}">próxima</a>
                        <a href="?page={{ page_obj.paginator.num_pages }}">última &raquo;</a>
                    {% endif %}
                </span>
            </div>
        {% else %}
            <p>Não há postagens para exibir.</p>
        {% endif %}
    {% endif %}
</div>
{% endblock content %}


{% block scripts %}
<script>
    $(document).ready(function() {
        // Lida com a ação de curtir um post
        $('.icon-like').on('click', function(event) {
            event.preventDefault(); // Impede o recarregamento da página

            const postId = $(this).data('post-id'); // Obtém o ID do post

            $.ajax({
                url: `/post/${postId}/like/`, // URL para a view de like
                method: 'GET',
                success: function(response) {
                    // Atualiza a contagem de likes
                    $('#likes-count-' + postId).text(response.likes_count);
                },
                error: function(xhr, status, error) {
                    console.error('Erro ao curtir o post:', error);
                }
            });
        });

        // Lida com a deleção do post
        $('.delete-post').on('click', function(event) {
            event.preventDefault(); // Impede o recarregamento da página

            const postId = $(this).data('post-id'); // Obtém o ID do post
            const confirmed = confirm('Tem certeza que deseja deletar este post?');

            if (confirmed) {
                // Se confirmado, faz a requisição AJAX para deletar o post
                $.ajax({
                    url: `/post/${postId}/delete/`, // URL para a view de deletar
                    method: 'POST', // Usando POST para deletar
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}' // Inclui o token CSRF
                    },
                    success: function(response) {
                        // Remove o post do DOM
                        $(`#post-${postId}`).remove(); // Supondo que o post tem o id "post-{id}"
                    },
                    error: function(xhr, status, error) {
                        console.error('Erro ao deletar o post:', error);
                    }
                });
            }
        });

        // Exibir textarea ao clicar no ícone de comentar
        $('.icon-comment').on('click', function(event) {
            event.preventDefault(); // Impede o recarregamento da página

            const postId = $(this).data('post-id'); // Obtém o ID do post
            $('#comment-section-' + postId).toggle(); // Alterna a visibilidade da seção de comentários
        });

        // Lidar com o envio do comentário
        $('.submit-comment').on('click', function(event) {
            const postId = $(this).data('post-id'); // Obtém o ID do post
            const content = $('#comment-section-' + postId + ' .comment-input').val(); // Obtém o conteúdo do comentário

            if (content.trim() === '') {
                alert('Por favor, escreva um comentário antes de enviar.');
                return;
            }

            $.ajax({
                url: `/post/${postId}/comment/`, // URL para a view de adicionar comentário
                method: 'POST',
                data: {
                    'content': content, // O conteúdo do comentário
                    'csrfmiddlewaretoken': '{{ csrf_token }}' // Inclui o token CSRF
                },
                success: function(response) {
                    // Alerta de sucesso
                    //alert('Comentário adicionado com sucesso!');

                    // Esconde a seção de comentários após o envio
                    $('#comment-section-' + postId).hide(); 

                    // Adiciona o novo comentário à lista
                    const newComment = `
                        <div class="comment">
                            <strong>${response.username}</strong> comentou em ${response.created_at}.
                            <p>${response.content}</p>
                        </div>
                    `;
                    // Prepend o novo comentário no topo da lista
                    $('#comments-list-' + postId).prepend(newComment);
                },
                error: function(xhr, status, error) {
                    console.error('Erro ao adicionar comentário:', error);
                }
            });
        });

        // Lidar com o cancelamento do comentário
        $('.cancel-comment').on('click', function() {
            const postId = $(this).parent().data('post-id');
            $('#comment-section-' + postId).hide(); // Esconde a seção de comentários
        });
    });

    // Função para esconder mensagens de alerta após um tempo
    hideMsg('.alert', 5000);
</script>
{% endblock scripts %}
